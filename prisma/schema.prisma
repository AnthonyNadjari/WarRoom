// Prisma schema for WarRoom
// NextAuth (User, Account, Session, VerificationToken) + Company, Contact, Interaction

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ---- NextAuth (Auth.js) ----
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  passwordHash  String?   @map("password_hash") // for Credentials provider
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts Account[]
  sessions Session[]

  companies     Company[]
  contacts      Contact[]
  interactions  Interaction[]
  processes     Process[]
  processNotes  ProcessNote[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires   DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ---- Enums ----
enum CompanyType {
  Bank
  HedgeFund       @map("Hedge Fund")
  AssetManager    @map("Asset Manager")
  PrivateEquity   @map("Private Equity")
  PropShop        @map("Prop Shop")
  Recruiter
  Other
}

enum ContactCategory {
  Sales
  Trading
  Structuring
  Investment
  HR
  Recruiter
  Other
}

enum Seniority {
  Analyst
  Associate
  VP
  Director
  MD
  Partner
  HR
  Recruiter
  Other
}

enum InteractionGlobalCategory {
  Sales
  Trading
  Structuring
  Investment
  Other
}

enum InteractionType {
  OfficialApplication @map("Official Application")
  LinkedInMessage     @map("LinkedIn Message")
  ColdEmail           @map("Cold Email")
  Call
  Referral
}

enum InteractionStatus {
  Sent
  Waiting
  FollowUp       @map("Follow-up")
  Interview
  Offer
  Rejected
  Closed
}

enum Priority {
  Low
  Medium
  High
}

enum Outcome {
  None
  Rejected
  Interview
  Offer
}

enum InteractionSourceType {
  Direct
  ViaRecruiter  @map("Via Recruiter")
}

enum ProcessStatus {
  Active
  Interviewing
  Offer
  Rejected
  Closed
}

enum InteractionStage {
  Application
  Screening
  PhoneInterview @map("Phone Interview")
  Technical
  FinalRound     @map("Final Round")
  OfferStage     @map("Offer Stage")
  Other
}

// ---- WarRoom business models ----
model Company {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  name          String
  type          CompanyType @default(Other)
  mainLocation  String?     @map("main_location")
  websiteDomain String?     @map("website_domain")
  logoUrl       String?     @map("logo_url")
  notes         String?
  createdAt     DateTime    @default(now()) @map("created_at")

  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contacts              Contact[]
  interactions          Interaction[]
  recruiterInteractions Interaction[] @relation("RecruiterInteractions")
  processes             Process[]

  @@index([userId])
  @@index([name])
  @@map("companies")
}

model Contact {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  companyId   String          @map("company_id")
  firstName   String?         @map("first_name")
  lastName    String?         @map("last_name")
  exactTitle  String?         @map("exact_title")
  category    ContactCategory?
  seniority   Seniority?
  location    String?
  email       String?         @unique
  phone       String?
  linkedinUrl String?         @map("linkedin_url")
  managerId   String?         @map("manager_id")
  notes       String?
  createdAt   DateTime       @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager Contact? @relation("ContactManager", fields: [managerId], references: [id], onDelete: SetNull)
  reports Contact[] @relation("ContactManager")
  interactions Interaction[]

  @@index([userId])
  @@index([companyId])
  @@index([managerId])
  @@index([email])
  @@map("contacts")
}

model Interaction {
  id                   String                    @id @default(uuid())
  userId               String                    @map("user_id")
  companyId            String                    @map("company_id")
  contactId            String                    @map("contact_id")
  roleTitle            String?                   @map("role_title")
  globalCategory       InteractionGlobalCategory? @map("global_category")
  type                 InteractionType?
  status               InteractionStatus         @default(Sent)
  priority             Priority?
  dateSent             DateTime?                 @map("date_sent") @db.Date
  lastUpdate           DateTime?                 @map("last_update") @db.Date
  nextFollowUpDate     DateTime?                 @map("next_follow_up_date") @db.Date
  outcome              Outcome?
  comment              String?
  stage                InteractionStage?
  completed            Boolean                   @default(false)
  sourceType           InteractionSourceType     @default(Direct) @map("source_type")
  recruiterId          String?                   @map("recruiter_id")
  processId            String?                   @map("process_id")
  parentInteractionId  String?                   @map("parent_interaction_id")
  createdAt            DateTime                  @default(now()) @map("created_at")
  updatedAt            DateTime                  @updatedAt @map("updated_at")

  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact          Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  recruiter        Company?     @relation("RecruiterInteractions", fields: [recruiterId], references: [id])
  process          Process?     @relation(fields: [processId], references: [id], onDelete: Cascade)
  parentInteraction  Interaction?  @relation("InteractionParent", fields: [parentInteractionId], references: [id], onDelete: SetNull)
  childInteractions  Interaction[] @relation("InteractionParent")

  @@index([userId])
  @@index([companyId])
  @@index([contactId])
  @@index([status])
  @@index([dateSent(sort: Desc)])
  @@index([nextFollowUpDate])
  @@index([recruiterId])
  @@index([processId])
  @@index([parentInteractionId])
  @@map("interactions")
}

model Process {
  id              String        @id @default(cuid())
  userId          String        @map("user_id")
  companyId       String        @map("company_id")
  roleTitle       String        @map("role_title")
  location        String?
  status          ProcessStatus @default(Active)
  sourceProcessId String?       @map("source_process_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sourceProcess   Process?  @relation("ProcessSource", fields: [sourceProcessId], references: [id], onDelete: SetNull)
  childProcesses  Process[] @relation("ProcessSource")
  interactions    Interaction[]
  notes           ProcessNote[]

  @@index([userId])
  @@index([companyId])
  @@index([sourceProcessId])
  @@map("processes")
}

model ProcessNote {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  processId String   @map("process_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  process Process @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@index([processId])
  @@index([userId])
  @@map("process_notes")
}
